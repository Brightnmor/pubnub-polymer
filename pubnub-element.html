<link rel="import" href="bower_components/polymer/polymer.html"> 

<!--
@element core-pubnub
@blurb Element providing encapsulation of the PubNub JS SDK.
@status alpha
@homepage 
-->
<polymer-element name="core-pubnub" constructor="corePubNub" attributes="publish_key subscribe_key auth_key uuid cipher_key noleave keepalive secret_key ssl windwoing jsonp ">
  <script src="https://cdn.pubnub.com/pubnub.min.js"></script>

  <script>

    Polymer('core-pubnub', {
      /**
        * The 'publish_key' attribute sets the publish_key to be used for publishing messages to a channel.
        * REQUIRED
        *
        * @attribute publish_key
        * @type string
        * @default ''
        */
      publish_key: '',

      /**
        * The 'subscribe_key' attribute sets the subscribe_key to be used for subscribing to a channel.
        * REQUIRED
        *
        * @attribute subscribe_key
        * @type string
        * @default ''
        */
      subscribe_key: '',

      /**
        * The 'auth_key' attribute sets the auth_key to be used for determining User-Level Access Manager permissions.
        * OPTIONAL
        *
        * @attribute auth_key 
        * @type string
        * @default undefined
        */
      auth_key: undefined,
      
      /**
        * The 'uuid' attribute sets the unique user id to be used to identify the client. By default a randomly generated uuid is created by the client.
        * OPTIONAL
        *
        * @attribute uuid
        * @type string
        * @default undefined
        */
      uuid: undefined,

      /**
        * The 'cipher_key' attribute sets the cryptographic key to use for message level encryption with AES.
        * OPTIONAL
        *
        * @attribute cipher_key
        * @type string
        * @default undefined
        */
      cipher_key: undefined,

      /**
        * The 'noleave' attribute, when set to true, explicitly disables presence leave events.
        * OPTIONAL
        *
        * @attribute noleave
        * @type boolean
        * @default false
        */
      noleave: undefined,

      /**
        * The 'keepalive' attribute sets the interval betwween keepalive pings.
        * OPTIONAL
        *
        * @attribute keepalive 
        * @type number
        * @default 60
        */
      keepalive: undefined,

      /**
        * The 'secret_key' attribute sets the secret_key used only to sign Access Manager API messages.
        * OPTIONAL
        *
        * @attribute secret_key
        * @type string
        * @default undefined 
        */
      secret_key: undefined,

      /**
        * The 'ssl' attribute, when set to true, enables transport layer encryption with SSL/TLS. 
        * OPTIONAL
        *
        * @attribute ssl 
        * @type boolean
        * @default false
        */
      ssl: undefined,

      /**
        * The 'windowing' sets the time interval in milliseconds that PubNub will use to optimize message delivery by bundling them into a single compressed payload.
        * OPTIONAL
        *
        * @attribute windowing
        * @type number
        * @default undefined
        */
      windowing: undefined,

      /**
       * The `jsonp` attribute, when set to true, explicitly enforces JSON(P) as the data transport method.
       * OPTIONAL 
       *
       * @attribute jsonp
       * @type boolean
       * @default undefined
       */
      jsonp: undefined,
      

      ready: function() {
          var settings = {
            publish_key: this.publish_key,
            subscribe_key: this.subscribe_key,
            auth_key: this.auth_key,
            uuid: this.uuid,
            cipher_key: this.cipher_key,
            noleave: this.noleave,
            keepalive: this.keepalive,
            secret_key: this.secret_key,
            ssl: this.ssl,
            windowing: this.windowing,
            jsonp: this.jsonp
          }
          console.log("CORE READY");
          this.pubnub = PUBNUB.init(settings);
          this.fire('ready', this.pubnub);
      },

      getPub: function() {
        console.log("Getting Pub");
        return this.pubnub;
      }
    });

  </script>

</polymer-element>

<polymer-element name="core-pubnub-subscribe" attributes="channel windowing heartbeat state messages subscribe">
  <script>
    Polymer('core-pubnub-subscribe', {
      channel: [],
      subscribe: true,
      ready: function() {
        var fire = this.fire;
        var self = this;
        this.sub = function() {
          self.messages =[];
          self.pubnub.subscribe({
            channel: self.channel,
            timetoken: self.timetoken,
            connect: function (m) {
              // Fire Connect Event.
              console.log("connect");
              fire('connect', m);
            },
            disconnect: function(m) {
              // Fire Disconnect Event.
              console.log("disconnect");
              fire('disconnect', m);
            },
            error: function(m) {
              // Fire Error Event.
              console.log("error");
              fire('error', m);
            },
            callback: function(m) {
              // Fire Message Event.
              console.log("message");
              console.log(m);
              self.messages.push(m);
              //console.log(messages);
              fire('callback', m);
            },
            presence: function(m) {
              // Fire Presence Event.
              console.log("presence");
              console.log(m);
              fire('presence', m);
            },
            reconnect: function(m) {
              // Fire Reconnect Event.
              console.log("reconnect");
              fire('reconnect', m);
            },
            restore: function(m) {
              // Fire Restore Event.
              console.log("restored");
              fire('restore', m);
            },
            windowing: self.windowing,
            heartbeat: self.heartbeat,
            state: self.state
          });
        };
        var onReady = function(e) {
          self.pubnub = e.detail;
          if (self.subscribe) {
            self.sub();
          }
          self.parentNode.removeEventListener('ready', onReady);
        };
        console.log(this.parentNode);
        this.parentNode.addEventListener('ready', onReady);
      },
      subscribeChanged: function(oldValue, newValue) {
        if (newValue) {
          this.sub();
        }
        else {
          this.pubnub.unsubscribe({
            channel: this.channel    
          });
        }
      }
    });
  </script>

</polymer-element>

<polymer-element name="core-pubnub-publish" attributes="channel message publish_key">
  <script>
    Polymer('core-pubnub-publish', {
      message: {},
      ready: function() {
        var self = this;
        var fire = this.fire;
        var onReady = function(e) {
          console.log("PUBLISHING TIME");
          var pubnub = e.detail;
          var ready = function() {
            console.log("GO FOR IT BRAH");
            fire('ready', pubnub);
          };
          pubnub.publish({
            channel: self.channel,
            message: self.message,
            publish_key: self.publish_key,
            callback: function(m) {
              fire('callback', m);
              ready();
            },
            error: function(m) {
              fire('error', m);
              ready();
            }
          });
          self.parentNode.removeEventListener('ready', onReady);
        }
        console.log(this.parentNode);
        this.parentNode.addEventListener('ready', onReady);
      },
    });
  </script>
</polymer-element>

<polymer-element name="core-pubnub-history" attributes="channel count end reverse start history">
  <script>
    Polymer('core-pubnub-history', {
      count: 100,
      ready: function() {
        var self = this;
        var fire = this.fire;
        var onReady = function(e) {
          console.log("CALL ME MAYBE");
          var pubnub = e.detail;
          var ready = function() {
            fire('ready', pubnub);
          };
          pubnub.history({
            channel: self.channel,
            count: self.count,
            end: self.end,
            reverse: self.reverse,
            start: self.start,
            callback: function(m) {
              self.history = m;
              console.log("HISTORY IS IN THE MAKING!");
              console.log(m);
              fire('callback', m);
              ready();
            },
            error: function(m) {
              fire('error', m);
              ready();
            }
          });
          self.parentNode.removeEventListener('ready', onReady);
        }
        this.parentNode.addEventListener('ready', onReady);
      }
    });
  </script>
</polymer-element>

<polymer-element name="core-pubnub-here-now" attributes="channel state uuids presence">
  <script>
    Polymer('core-pubnub-here-now', {
      state: false,
      uuids: true,
      presence: [], 
      ready: function() {
        var self = this;
        var fire = this.fire;
        var onReady = function(e) {
          var pubnub = e.detail;
          var ready = function() {
            fire('ready', pubnub);
          };
          pubnub.here_now({
            channel: self.channel,
            state: self.state,
            uuids: self.uuids,
            error: function(m) {
              console.log('error');
              fire('error', m);
            },
            callback: function(m) {
              console.log('callback');
              self.presence = m.uuids;
              console.log(m);
              fire('callback', m);
            }
          });
          self.parentNode.removeEventListener('ready', onReady);
        }
        this.parentNode.addEventListener('ready', onReady);
      }
    });
  </script>
</polymer-element>

<polymer-element name="core-pubnub-where-now" attributes="uuid presence">
  <script>
    Polymer('core-pubnub-where-now', {
        presence: [],      
        ready: function() {
        var self = this;
        var fire = this.fire;
        var onReady = function(e) {
          var pubnub = e.detail;
          var ready = function() {
            fire('ready', pubnub);
          };
          pubnub.where_now({
            uuid: self.uuid,
            callback: function(m) {
              console.log(m);
              self.presence = m.channels;
              fire('callback', m);
              ready();
            },
            error: function(m) {
              console.log(m);
              fire('error', m);
              ready();
            }
          });
          self.parentNode.removeEventListener('ready', onReady);
        }
        this.parentNode.addEventListener('ready', onReady);
      }
    });
  </script>
</polymer-element>
